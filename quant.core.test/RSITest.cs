using System;
using System.Collections.Generic;
using System.Text;
using Microsoft.VisualStudio.TestTools.UnitTesting;
using System.Diagnostics;

namespace quant.core.test
{
    [TestClass]
    public class RSITest
    {
        // date, open, high, low, close
        static string[,] data = new string[,]   {
                {"1/3/2011","11577.43","11711.47","11577.35","11670.75"},
                {"1/4/2011","11670.9","11698.22","11635.74","11691.18"},
                {"1/5/2011","11688.61","11742.68","11652.89","11722.89"},
                {"1/6/2011","11716.93","11736.74","11667.46","11697.31"},
                {"1/7/2011","11696.86","11726.94","11599.68","11674.76"},
                {"1/10/2011","11672.34","11677.33","11573.87","11637.45"},
                {"1/11/2011","11638.51","11704.12","11635.48","11671.88"},
                {"1/12/2011","11673.62","11782.23","11673.62","11755.44"},
                {"1/13/2011","11753.7","11757.25","11700.53","11731.9"},
                {"1/14/2011","11732.13","11794.15","11698.83","11787.38"},
                {"1/18/2011","11783.82","11858.78","11777.99","11837.93"},
                {"1/19/2011","11834.21","11861.24","11798.46","11825.29"},
                {"1/20/2011","11823.7","11845.16","11744.77","11822.8"},
                {"1/21/2011","11822.95","11905.48","11822.8","11871.84"},
                {"1/24/2011","11873.43","11982.94","11867.98","11980.52"},
                {"1/25/2011","11980.52","11985.97","11898.74","11977.19"},
                {"1/26/2011","11978.85","12020.52","11961.83","11985.44"},
                {"1/27/2011","11985.36","12019.53","11971.93","11989.83"},
                {"1/31/2011","11824.39","11891.93","11817.88","11891.93"},
                {"2/1/2011","11892.5","12050.75","11892.5","12040.16"},
                {"2/2/2011","12038.27","12057.91","12018.51","12041.97"},
                {"2/3/2011","12040.68","12080.54","11981.05","12062.26"},
                {"2/4/2011","12061.73","12092.42","12025.78","12092.15"},
                {"2/7/2011","12092.38","12188.76","12092.3","12161.63"},
                {"2/8/2011","12152.7","12238.79","12150.05","12233.15"},
                {"2/9/2011","12229.29","12254.23","12188.19","12239.89"},
                {"2/10/2011","12239.66","12239.66","12156.94","12229.29"},
                {"2/11/2011","12227.78","12285.94","12180.48","12273.26"},
                {"2/14/2011","12266.83","12276.21","12235.91","12268.19"},
                {"2/15/2011","12266.75","12267.66","12193.27","12226.64"},
                {"2/16/2011","12219.79","12303.16","12219.79","12288.17"},
                {"2/17/2011","12287.72","12331.31","12253.24","12318.14"},
                {"2/22/2011","12389.74","12389.82","12176.31","12212.79"},
                {"2/23/2011","12211.81","12221.12","12063.43","12105.78"},
                {"2/24/2011","12104.56","12129.62","11983.17","12068.5"},
                {"2/25/2011","12060.93","12151.03","12060.93","12130.45"},
                {"2/28/2011","12130.45","12235.04","12130.15","12226.34"},
                {"3/1/2011","12226.49","12261.38","12054.99","12058.02"},
                {"3/2/2011","12057.34","12115.12","12018.63","12066.8"},
                {"3/3/2011","12068.01","12283.1","12068.01","12258.2"},
                {"3/7/2011","12171.09","12243.44","12041.6","12090.03"},
                {"3/8/2011","12085.87","12251.2","12072.21","12214.38"},
                {"3/9/2011","12211.16","12257.82","12156.6","12213.09"},
                {"3/10/2011","12211.43","12211.43","11974.39","12023.89"},
                {"3/11/2011","11976.96","12087.01","11936.32","12044.4"},
                {"3/14/2011","12042.13","12042.13","11897.31","11993.16"},
                {"3/15/2011","11988.69","11988.69","11696.25","11891.21"},
                {"3/16/2011","11854.2","11856.7","11555.48","11613.3"},
                {"3/17/2011","11614.89","11800.54","11614.82","11774.59"},
                {"3/18/2011","11777.23","11927.09","11777.23","11858.52"},
                {"3/21/2011","11860.11","12078.3","11860.11","12036.53"},
                {"3/22/2011","12036.37","12050.98","12002.85","12018.63"},
                {"3/23/2011","12018.4","12116.14","11972.61","12086.02"},
                {"3/24/2011","12087.54","12191.18","12087.54","12170.56"},
                {"3/25/2011","12170.71","12259.79","12170.71","12220.59"},
                {"3/28/2011","12221.19","12272.92","12197.88","12197.88"},
                {"3/29/2011","12194.48","12285.41","12173.51","12279.01"},
                {"3/30/2011","12280.07","12383.46","12280.07","12350.61"},
                {"3/31/2011","12350.76","12381.68","12319.01","12319.73"},
                {"4/1/2011","12321.02","12419.71","12321.02","12376.72"},
                {"4/4/2011","12374.6","12407.41","12369.15","12400.03"},
                {"4/5/2011","12402.08","12438.14","12353.34","12393.9"},
                {"4/6/2011","12386.66","12450.93","12386.66","12426.75"},
                {"4/7/2011","12426.45","12440.56","12328.36","12409.49"},
                {"6/13/2011","11945.33","12011.66","11917.78","11952.97"},
                {"6/14/2011","11951.38","12120.8","11951.38","12076.11"},
                {"6/15/2011","12075.12","12075.2","11862.53","11897.27"},
                {"6/16/2011","11896.13","11990.02","11875.77","11961.52"},
                {"6/17/2011","11962.66","12072.89","11962.51","12004.36"},
                {"6/21/2011","12081.33","12217.33","12081.18","12190.01"},
                {"6/22/2011","12189.71","12207.99","12105.85","12109.67"},
                {"6/23/2011","12108.35","12108.73","11874.94","12050"},
                {"6/24/2011","12049.24","12057.19","11925.42","11934.58"},
                {"6/27/2011","11934.66","12098.81","11934.05","12043.56"},
                {"6/28/2011","12042.28","12190.43","12042.28","12188.69"},
                {"6/29/2011","12187.63","12284.39","12175.86","12261.42"},
                {"6/30/2011","12262.25","12427.09","12262.1","12414.34"},
                {"7/1/2011","12412.07","12596.13","12404.08","12582.77"},
                {"7/5/2011","12583","12601.8","12540.58","12569.87"},
                {"7/6/2011","12562.47","12643.24","12539.21","12626.02"},
                {"7/7/2011","12627.23","12753.89","12627.23","12719.49"},
                {"7/8/2011","12717.9","12717.9","12567.41","12657.2"},
                {"7/11/2011","12655.62","12655.84","12470.3","12505.76"},
                {"7/12/2011","12505.54","12570.58","12446.88","12446.88"},
                {"7/13/2011","12447.33","12611.04","12447.33","12491.61"},
                {"7/14/2011","12491.53","12581.98","12414.41","12437.12"},
                {"7/15/2011","12437.12","12504.82","12406.09","12479.73"},
                {"7/18/2011","12475.11","12475.26","12296.23","12385.16"},
                {"7/19/2011","12386.03","12607.56","12385.96","12587.42"},
                {"7/20/2011","12583.68","12603.51","12546.56","12571.91"},
                {"7/21/2011","12567.07","12751.43","12566.61","12724.41"},
                {"7/22/2011","12724.71","12740.87","12644.19","12681.16"},
                {"7/25/2011","12679.72","12679.95","12536.19","12592.8"},
                {"7/26/2011","12592.12","12593.4","12489.04","12501.3"},
                {"7/27/2011","12498.42","12498.65","12289.69","12302.55"},
                {"7/28/2011","12301.72","12384.9","12226.83","12240.11"},
                {"7/29/2011","12239.36","12243.07","12083.45","12143.24"},
                {"8/1/2011","12144.22","12282.42","11998.08","12132.49"},
                {"8/2/2011","12129.77","12130.3","11865.56","11866.62"},
                {"8/3/2011","11863.74","11904.91","11700.34","11896.44"},
                {"8/4/2011","11893.86","11893.94","11372.14","11383.68"},
                {"8/5/2011","11383.98","11555.41","11139","11444.61"},
                {"8/8/2011","11433.93","11434.09","10809.85","10809.85"},
                {"8/9/2011","10810.91","11244.01","10604.07","11239.77"},
                {"8/10/2011","11228","11228","10686.49","10719.94"},
                {"8/11/2011","10729.85","11278.9","10729.85","11143.31"},
                {"8/12/2011","11143.46","11346.67","11142.18","11269.02"},
                {"8/15/2011","11269.85","11484.6","11269.85","11482.9"},
                {"8/16/2011","11480.48","11488.01","11292.63","11405.93"},
                {"8/17/2011","11392.01","11529.67","11322.3","11410.21"},
                {"8/18/2011","11406.27","11406.5","10881.6","10990.58"},
                {"8/19/2011","10989.75","11086.4","10801.41","10817.65"},
                {"8/22/2011","10820.37","11020.55","10820.37","10854.65"},
                {"8/23/2011","10854.58","11176.84","10854.43","11176.76"},
                {"8/24/2011","11175.78","11331.57","11113.04","11320.71"},
                {"8/25/2011","11321.02","11406.39","11106.76","11149.82"},
                {"8/26/2011","11145.2","11326.43","10929.2","11284.54"},
                {"8/29/2011","11286.65","11541.78","11286.58","11539.25"},
                {"8/30/2011","11532.13","11630.07","11429.39","11559.95"},
                {"8/31/2011","11560.48","11712.6","11528.08","11613.53"},
                {"9/1/2011","11613.3","11716.84","11488.46","11493.57"},
                {"9/2/2011","11492.06","11492.14","11211.35","11240.26"},
                {"9/6/2011","11237.31","11237.46","10932.53","11139.3"},
                {"9/7/2011","11137.63","11414.86","11137.63","11414.86"},
                {"9/8/2011","11414.86","11477.3","11283.74","11295.81"},
                {"9/9/2011","11294.6","11294.83","10935.64","10992.13"},
                {"9/12/2011","10990.01","11062.03","10824.76","11061.12"},
                {"9/13/2011","11054.99","11140.85","10987.18","11105.85"},
                {"9/14/2011","11106.83","11386.78","10993.84","11246.73"},
                {"9/15/2011","11247.72","11433.4","11247.49","11433.18"},
                {"9/16/2011","11433.71","11532.47","11407.41","11509.09"},
                {"9/19/2011","11506.67","11506.82","11255.25","11401.01"},
                {"9/20/2011","11401.47","11550.22","11373.92","11408.66"},
                {"9/21/2011","11408.58","11447.86","11117.28","11124.84"},
                {"9/22/2011","11121.89","11122.12","10597.14","10733.83"},
                {"9/23/2011","10732.77","10808.49","10638.73","10771.48"},
                {"9/26/2011","10771.78","11057.49","10771.78","11043.86"},
                {"9/27/2011","11045.23","11369.3","11045.23","11190.69"},
                {"9/28/2011","11189.1","11317.08","10996.98","11010.9"},
                {"9/29/2011","11012.79","11271.14","10965.45","11153.98"},
                {"9/30/2011","11152.32","11152.39","10909.52","10913.38"},
                {"10/3/2011","10912.1","10979.19","10653.34","10655.3"},
                {"10/4/2011","10651.44","10825.44","10404.49","10808.71"},
                {"10/5/2011","10800.47","10950.89","10738.1","10939.95"},
                {"10/6/2011","10939.87","11132.6","10858.67","11123.33"},
                {"10/7/2011","11123.41","11232.05","11051.13","11103.12"},
                {"10/10/2011","11104.56","11433.33","11104.56","11433.18"},
                {"10/11/2011","11432.8","11447.86","11365.67","11416.3"},
                {"10/12/2011","11417.36","11625.3","11417.28","11518.85"},
                {"10/13/2011","11518.09","11518.09","11377.82","11478.13"},
                {"10/14/2011","11478.97","11646.83","11478.66","11644.49"},
                {"10/17/2011","11643.35","11643.35","11378.35","11397"},
                {"10/18/2011","11396.17","11652.74","11296.12","11577.05"},
                {"10/19/2011","11577.54","11633.7","11469.17","11504.62"},
                {"10/20/2011","11502.13","11581.25","11391.14","11541.78"},
                {"10/21/2011","11543.22","11812.46","11542.84","11808.79"},
                {"10/24/2011","11807.96","11940.75","11805.77","11913.62"},
                {"10/25/2011","11912.63","11912.86","11682.52","11706.62"},
                {"10/26/2011","11707.76","11891.21","11694.36","11869.04"},
                {"10/27/2011","11872.07","12284.31","11872.07","12208.55"},
                {"10/28/2011","12207.34","12251.92","12164.24","12231.11"},
                {"10/31/2011","12229.22","12229.29","11954.41","11955.01"},
                {"11/1/2011","11951.53","11951.76","11630.03","11657.96"},
                {"11/2/2011","11658.49","11876.83","11658.49","11836.04"},
                {"11/3/2011","11835.59","12065.93","11835.43","12044.47"},
                {"11/4/2011","12043.41","12043.49","11850.31","11983.24"},
                {"11/7/2011","11983.02","12074.44","11880.69","12068.39"},
                {"11/8/2011","12055.52","12187.51","12002.17","12170.18"},
                {"11/9/2011","12166.4","12166.4","11736.93","11780.94"},
                {"11/10/2011","11780.03","11961.14","11779.88","11893.79"},
                {"11/11/2011","11896.28","12179.72","11896.28","12153.68"},
                {"11/14/2011","12153","12170.56","12027.03","12078.98"},
                {"11/15/2011","12077.92","12165.11","12001.26","12096.16"},
                {"11/16/2011","12084.74","12109.03","11890.57","11905.59"}
        };
        [TestMethod]
        public void TestRSI()
        {
            var rs = new RS(14);
            var rsi = new RSI(14);
            double prev = double.NaN;
            for (int itr = 0; itr < data.GetLength(0); ++itr)
            {
                var dt = DateTime.Parse(data[itr, 0]);
                var close = double.Parse(data[itr, 4]);
                var rs_val = rs.Calc(close - prev);
                var rsi_val = rsi.Calc(close);
                var sb = new StringBuilder();
                sb.Append($"{dt.ToString("MM/dd/yyyy")}\t{Math.Round(close)}\t{(close - prev).ToString("0")}");
                sb.Append($"\t{rs_val.ToString("0.0")}\t{rsi_val.ToString("0")}");

                prev = close;
                Trace.WriteLine(sb.ToString());
            }
        }
        /// <summary>
        /// Excelsheet "MACD Tutorial" from
        /// http://investexcel.net/how-to-calculate-macd-in-excel/
        /// </summary>
        [TestMethod]
        public void MACDTest()
        {
            MACD macd = new MACD(12,26);
            EMA signal = new EMA(9);
            Histogram<MACD> hist = new Histogram<MACD>(9, () => new MACD(12, 26));
            double[] data = { 459.99, 448.85, 446.06, 450.81, 442.8, 448.97,
                444.57, 441.4, 430.47, 420.05, 431.14, 425.66, 430.58, 431.72,
                437.87, 428.43, 428.35, 432.5, 443.66, 455.72, 454.49, 452.08, 452.73,
                461.91, 463.58, 461.14, 452.08, 442.66, 428.91, 429.79, 431.99, 427.72,
                423.2, 426.21, 426.98, 435.69, 434.33, 429.8, 419.85, 426.24, 402.8, 392.05,
                390.53, 398.67, 406.13, 405.46, 408.38, 417.2, 430.12, 442.78, 439.29, 445.52,
                449.98, 460.71, 458.66, 463.84, 456.77, 452.97, 454.74, 443.86, 428.85, 434.58,
                433.26, 442.93, 439.66, 441.35 };
            foreach (var val in data)
            {
                var retVal = macd.Calc(val);
                var sig = signal.Calc(retVal);
                var hs = hist.Calc(val);
                Trace.WriteLine($"{val}\t{retVal.ToString("0.00000")}\t{sig.ToString("0.0000")}\t{hs.ToString("0.0000")}");
            }
        }
        [TestMethod]
        public void PPOTest()
        {
//            var hist = new Histogram<PPO>(12, 26, 9, (f, s) => new PPO(f, s));
        }
    }
}
